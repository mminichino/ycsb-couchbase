package site.ycsb.db.couchbase3;

import org.apache.commons.cli.*;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Properties;

/**
 * Clean Cluster after Testing.
 */
public final class ClusterClean {

  public static void main(String[] args) {
    Options options = new Options();
    CommandLine cmd = null;
    Properties properties = new Properties();

    Option source = new Option("p", "properties", true, "source properties");
    Option queryMode = new Option("q", "query", false, "query mode");
    source.setRequired(true);
    queryMode.setRequired(false);
    options.addOption(source);
    options.addOption(queryMode);

    CommandLineParser parser = new DefaultParser();
    HelpFormatter formatter = new HelpFormatter();

    try {
      cmd = parser.parse(options, args);
    } catch (ParseException e) {
      System.out.println(e.getMessage());
      formatter.printHelp("ClusterClean", options);
      System.exit(1);
    }

    String propFile = cmd.getOptionValue("properties");

    try {
      properties.load(Files.newInputStream(Paths.get(propFile)));
    } catch (IOException e) {
      System.out.println("can not open properties file: " + e.getMessage());
      e.printStackTrace(System.err);
      System.exit(1);
    }

    try {
      if (cmd.hasOption("query")) {
        CouchbaseQueryCleanup clean = new CouchbaseQueryCleanup();
        clean.testClean(properties);
      } else {
        CouchbaseTestCleanup clean = new CouchbaseTestCleanup();
        clean.testClean(properties);
      }
    } catch (Exception e) {
      System.err.println("Error: " + e);
      e.printStackTrace(System.err);
      System.exit(1);
    }
  }

  private ClusterClean() {
    super();
  }
}
